<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>검색 결과</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #map {
      width: 100vw;
      height: 100vh;
    }
    .error-message {
      color: red;
      text-align: center;
      margin-top: 20px;
    }
  </style>
  <script th:src="'https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=' + ${clientId}"></script>
</head>
<body>
<div id="map"></div>
<div class="error-message" th:if="${#lists.isEmpty(pharmacies)}">지도에 표시할 데이터가 없습니다.</div>

<script th:inline="javascript">
  // Thymeleaf에서 pharmacies 데이터를 JSON으로 변환
  let pharmacies = /*[[${pharmacies}]]*/ [];
  // 데이터가 배열로 변환되었는지 확인
  console.log(pharmacies);

  let currentInfoWindow = null;  // 현재 열린 정보 창을 저장할 변수

  function initMap(lat, lng) {
    var map = new naver.maps.Map('map', {
      center: new naver.maps.LatLng(lat, lng),
      zoom: 18, // 줌 레벨 조정
      mapTypeId: naver.maps.MapTypeId.NORMAL
    });

    if (pharmacies.length === 0) {
      document.querySelector('.error-message').textContent = '약국 정보를 찾을 수 없습니다.';
      return;
    }
    // 약국 데이터를 지도에 마커로 표시
    pharmacies.forEach(pharmacy => {
      var marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(pharmacy.latitude, pharmacy.longitude),
        map: map,
        title: pharmacy.pname
      });

      var infoWindowContent = `<div><strong>${pharmacy.pname}</strong><br>${pharmacy.paddress}<br>${pharmacy.pnumber}<br>${pharmacy.phours}<br>`;
      pharmacy.drugs.forEach(drug => {
        infoWindowContent += `약 이름: ${drug.dname}<br>약 개수: ${drug.quantity}<br>`;
      });
      infoWindowContent += '</div>';

      var infoWindow = new naver.maps.InfoWindow({
        content: infoWindowContent
      });
      naver.maps.Event.addListener(marker, 'click', () => {
        // 현재 열린 정보 창이 있으면 닫기
        if (currentInfoWindow) {
          currentInfoWindow.close();
        }

        // 현재 마커의 정보 창 열기
        if (currentInfoWindow === infoWindow) {
          currentInfoWindow = null;  // 현재 정보 창이 클릭된 정보 창과 같으면 닫기
        } else {
          infoWindow.open(map, marker);
          currentInfoWindow = infoWindow;  // 현재 열린 정보 창을 업데이트
        }
      });
    });
  }
  // 원하는 위치로 지도 초기화 (36.7696, 126.9324)
  initMap(36.773184, 126.933296);
</script>
</body>
</html>
